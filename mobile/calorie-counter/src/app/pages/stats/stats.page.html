<mat-card>
  <h3>Статистика по дням</h3>

  <div class="controls">
    <mat-form-field appearance="fill">
      <mat-label>Период</mat-label>
      <mat-select [(ngModel)]="selectedPeriod" (selectionChange)="updatePeriod()">
        <mat-option value="week">Неделя</mat-option>
        <mat-option value="month">Месяц</mat-option>
        <mat-option value="quarter">Квартал</mat-option>
        <mat-option value="custom">Пользовательский</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="dates" *ngIf="selectedPeriod==='custom'">
      <input type="date" [(ngModel)]="customStart" (change)="updatePeriod()">
      <input type="date" [(ngModel)]="customEnd" (change)="updatePeriod()">
    </div>

    <mat-button-toggle-group [(ngModel)]="view">
      <mat-button-toggle value="chart">График</mat-button-toggle>
      <mat-button-toggle value="table">Таблица</mat-button-toggle>
    </mat-button-toggle-group>

    <button mat-raised-button (click)="downloadPdf()">PDF отчёт</button>
  </div>

  <!-- Легенда по периоду -->
  <div class="legend" *ngIf="legend.totalMacroKcal > 0">
    <span class="dot p"></span>
    Б {{ legend.proteinsPct | number:'1.0-0' }}%
    <span class="dot f"></span>
    Ж {{ legend.fatsPct | number:'1.0-0' }}%
    <span class="dot c"></span>
    У {{ legend.carbsPct | number:'1.0-0' }}%
  </div>

  <ng-container *ngIf="view==='chart'">
    <div class="chart">
      <!-- Шкала (совпадает по ширине с дорожкой) -->
      <div class="scale" *ngIf="ticks.length">
        <div class="tick" *ngFor="let t of ticks">
          <span>{{ t | number:'1.0-0' }}</span>
        </div>
      </div>

      <!-- Строки по дням -->
      <div class="row" *ngFor="let d of data">
        <div class="label">{{ d.date | date:'dd.MM' }}</div>

        <div class="track" [attr.aria-label]="'Сумма ккал ' + (d.totals.calories | number:'1.0-0')">
          <div
            class="bar-fill"
            [style.width.%]="effectiveMax ? (d.totals.calories / effectiveMax) * 100 : 0"
          >
            <span
              class="seg p"
              [style.width.%]="macroShare(d, 'p')"
              [attr.title]="macroTooltip(d, 'p')"
            ></span>
            <span
              class="seg f"
              [style.width.%]="macroShare(d, 'f')"
              [attr.title]="macroTooltip(d, 'f')"
            ></span>
            <span
              class="seg c"
              [style.width.%]="macroShare(d, 'c')"
              [attr.title]="macroTooltip(d, 'c')"
            ></span>
          </div>
        </div>

        <div class="value">{{ d.totals.calories | number:'1.0-0' }}</div>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="view==='table'">
    <table class="stats-table">
      <thead>
        <tr><th>Дата</th><th>Ккал</th><th>Б</th><th>Ж</th><th>У</th></tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of data">
          <td>{{ d.date | date:'dd.MM' }}</td>
          <td>{{ d.totals.calories | number:'1.0-0' }}</td>
          <td>{{ d.totals.proteins | number:'1.0-0' }}</td>
          <td>{{ d.totals.fats | number:'1.0-0' }}</td>
          <td>{{ d.totals.carbs | number:'1.0-0' }}</td>
        </tr>
      </tbody>
    </table>
  </ng-container>
</mat-card>
